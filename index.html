<html>
  <head>
    <title>CanDef - Candle Definition</title>
  </head>
  <body>
    <h1>CanDef</h1>
    <label>maxCandleDefinitionRange:</label>
    <input type="number" id="input_maxCandleDefinitionRange"/>
    </br>
    <textarea style="height:20px;width:50%;" id="input_config" placeholder="config"></textarea>
    <textarea style="height:200px;width:50%;" id="input_data" placeholder="input data"></textarea>
    <br/>
    <input type="button" value="Generate" onclick="generateResultFromInput()"/>
    <br/>
    <br/>
    <textarea style="height:200px;width:50%;" id="output_data" placeholder="output data"></textarea>
  </body>
  <script src="vendor/jquery-3.5.1.min.js"></script>
  <script>
    jQuery(document).ready(function () {
      $("#input_data").val(
        "10,10,10,10\n" +
        "10,12,10,10\n" +
        "10,10,8,10\n" +
        "10,12,8,10\n" +
        "10,12,10,12\n" +
        "10,14,10,12\n" +
        "10,12,8,12\n" +
        "10,14,8,12\n" +
        "10,10,8,8\n" +
        "10,12,8,8\n" +
        "10,10,6,8\n" +
        "10,12,6,8\n"
      );

      $("#input_maxCandleDefinitionRange").val(maxCandleDefinitionRange);
      $("#input_config").val(JSON.stringify(candleDefinitionPairs));
      // $("#input_config").val(JSON.stringify(candleDefinitionPairs, null, 2));
    });

    let maxCandleDefinitionRange = 5;

    let candleDefinitionPairs = [
        {"defA": "O","defB": "H","defComp": ">","ignore": false},
        {"defA": "O","defB": "H","defComp": "<","ignore": true},
        {"defA": "O","defB": "H","defComp": "==","ignore": true},
        {"defA": "O","defB": "L","defComp": ">","ignore": false},
        {"defA": "O","defB": "L","defComp": "<","ignore": true},
        {"defA": "O","defB": "L","defComp": "==","ignore": true},
        {"defA": "O","defB": "C","defComp": ">","ignore": false},
        {"defA": "O","defB": "C","defComp": "<","ignore": true},
        {"defA": "O","defB": "C","defComp": "==","ignore": true},
        {"defA": "H","defB": "L","defComp": ">","ignore": false},
        {"defA": "H","defB": "L","defComp": "<","ignore": true},
        {"defA": "H","defB": "L","defComp": "==","ignore": true},
        {"defA": "H","defB": "C","defComp": ">","ignore": false},
        {"defA": "H","defB": "C","defComp": "<","ignore": true},
        {"defA": "H","defB": "C","defComp": "==","ignore": true},
        {"defA": "L","defB": "C","defComp": ">","ignore": false},
        {"defA": "L","defB": "C","defComp": "<","ignore": true},
        {"defA": "L","defB": "C","defComp": "==","ignore": true},
      ];

    function candleDefinitionPairCompare(c, candle1, candle2) {
      if (c.defComp == ">") {
        return parseInt(candle1[c.defA]) > parseInt(candle2[c.defB])
      } else if (c.defComp == "<") {
        return parseInt(candle1[c.defA]) < parseInt(candle2[c.defB])
      } else if ((c.defComp == "=") || (c.defComp == "==")) {
        return parseInt(candle1[c.defA]) == parseInt(candle2[c.defB])
      }
    }

    function generateResultFromInput() {
      // setup config
      maxCandleDefinitionRange = $("#input_maxCandleDefinitionRange").val();
      candleDefinitionPairs = JSON.parse($("#input_config").val());

      // getting result from input
      let inputData = $("#input_data").val();
      let candles = getCandle(inputData);
      let result = generateResult(candles);
      // console.log(result);
      $("#output_data").val(formatResult(result));
    }

    function generateResult(candles) {
      let result = [];
      for (let i=0; i<candles.length; i++) {
        let candleResults = [];
        for (let cDefRange=1; cDefRange<=maxCandleDefinitionRange; cDefRange++) {
          let candleResult = "";
          // validate out of array range
          if ((i+1-cDefRange) < 0) {
            continue;
          }
          for (let iA=0; iA<cDefRange; iA++) {
            let candleA = candles[i-iA];
            for (let iB=0; iB<cDefRange; iB++) {
              let candleB = candles[i-iB];
              for (let j=0; j<candleDefinitionPairs.length; j++) {
                let c = candleDefinitionPairs[j];
                if (c.ignore) {
                  continue;
                }
                if (candleDefinitionPairCompare(c, candleA, candleB)) {
                  candleResult += ("AND(" + c.defA + (iA+1) + c.defComp + c.defB + (iB+1) + ")");
                }
              }
            }
          }
          // remove the first AND if not empty
          if (candleResult != "") {
            candleResult = candleResult.substr(3);
          }

          // push to stack
          candleResults.push(candleResult);
        }
        result.push(candleResults);
      }
      return result
    }

    function formatResult(res) {
      let resultString = "";
      for (let i=0; i<res.length; i++) {
        let line = "";
        for (let j=0; j<res[i].length; j++) {
          line += ("," + res[i][j]);
        }
        // remove last ","
        if (line != "") {
          line = line.substr(1);
        }
        resultString += (line + "\n");
      }
      return resultString
    }

    function getCandle(inputRawRaw) {
      let inputSlicedRaw = inputRawRaw.split("\n");
      let inputSlicedSliced = [];
      for (let i=0; i<inputSlicedRaw.length; i++) {
        let slicedCandle = inputSlicedRaw[i].split(",");
        let slicedCandleMap = {};
        slicedCandleMap["O"] = slicedCandle[0];
        slicedCandleMap["H"] = slicedCandle[1];
        slicedCandleMap["L"] = slicedCandle[2];
        slicedCandleMap["C"] = slicedCandle[3];
        inputSlicedSliced.push(slicedCandleMap);
      }
      return inputSlicedSliced
    }
  </script>
</html>
